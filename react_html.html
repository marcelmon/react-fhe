<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>Hello World</title>
		<script src="https://unpkg.com/react@16/umd/react.development.js"></script>
		<script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
		<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
	</head>
	<body>
		<div id="root"></div>
		<script type="text/babel">



var baseUrl = "http://localhost:8081";

var userId = 665;
function httpRequest(url, ...params){
	// Return a new promise.
	return new Promise(function(resolve, reject) {
		// Do the usual XHR stuff
		var req = new XMLHttpRequest();
		req.open('POST', url);

		req.onload = function() {

			if (req.status == 200) {
				console.log("got response : " + req.response);
				resolve(req.response);
			}
			else {
				reject(Error(req.statusText));
			}
		};
		req.onerror = function() {
			reject(Error("Network Error"));
		};
		req.send();
	});
}


class QueryBox extends React.Component {
	constructor(props){
		super(props);
		this.state = {
			colId 			: props.colId,
			queryRetData 	: null
		};
		this.handleSubmitQuery = this.handleSubmitQuery.bind(this);
	}

	handleSubmitQuery(e){

		e.preventDefault();

		var queryString = e.target.queryString.value;
		var queryUrl = baseUrl+'/encrypted_query/'+userId+'/'+this.props.colId+'/query/'+queryString+'/';
		var queryPromise = httpRequest(queryUrl);
		queryPromise.then((queryData) => {
			this.setState({queryRetData: JSON.parse(queryData)});
		}).catch(function(err){
			console.log('submitQuery err');
			console.log(err);
		});
	}

	render(){
		if(!this.props.colId){
			return(<div>Select a collection and encrypt</div>);
		}
		else{
			if(!this.state.queryRetData){
				return(
					<div>
						<form onSubmit={this.handleSubmitQuery}>
							<table><tbody><tr>
								<td><div>Key:<input type="text" name="queryString"/></div></td>
								<td><input type="submit" value="Query data"/></td>
							</tr></tbody></table>
						</form>
						<div>Submit a Query</div>
					</div>
				);
			}
			else{
				return(
					<div>
						<form onSubmit={this.handleSubmitQuery}>
							<table><tbody><tr>
								<td><div>Key:<input type="text" name="queryString"/></div></td>
								<td><input type="submit" value="Query data"/></td>
							</tr></tbody></table>
						</form>
						<div>
							{this.state.queryRetData}
						</div>
					</div>
				);
			}
		}
	}
};


class KeyValueViewer extends React.Component {
	constructor(props){
		super(props);
		this.state = {
			colId 			: props.colId,
			keyValuesAndIds	: props.keyValuesAndIds,  // Holds colloquial name and collection id
			selectedKVInfo	: props.selectedKVInfo,
			encryptedIds 	: props.encryptedIds,
		};
		this.handleNewKeyValue 	=this.handleNewKeyValue.bind(this);
		this.handleEncryptAll 	=this.handleEncryptAll.bind(this);
	}

	KeyValueEncryptedBits(kvId){
		if(this.props.encryptedIds == null){
			return(
				<div>Encrypt first null</div>
			);
		}
		for (var i = 0; i < this.props.encryptedIds.length; i++) {
			if(this.props.encryptedIds[i].kvPairId == kvId){
				return(
					<table><tbody><tr>
					<td>
						<table><tbody><tr>
						{this.props.encryptedIds[i].bitIds.map((aBitId) => {
							return(<td><button onClick={()=>this.props.selectKeyBit(this.props.colId, kvId, aBitId)}>Bit: {aBitId}</button></td>)
						})}
						</tr></tbody></table>
					</td>
					<td><button onClick={()=>this.props.selectValue(this.props.colId, kvId)}>Key:{kvId}</button></td>
					</tr></tbody></table>
				);
				break;
			}
		};
		return(
			<div>Encrypt first {kvId}</div>
		);
	}

	KeyValueRow(kvId, key, value){
		return(
			<table><tbody><tr>
				<td><div>{key}</div></td>
				<td><div>{value}</div></td>
				<td><button onClick={()=>this.props.updateKV(this.props.colId, kvId)}>Update</button></td>
				<td><button onClick={()=>this.props.deleteKV(this.props.colId, kvId)}>Delete</button></td>
				<td>{this.KeyValueEncryptedBits(kvId)}</td>
			</tr></tbody></table>
		);
	}

	handleNewKeyValue(e){
		e.preventDefault();
		this.props.newKeyValue(this.props.colId, e.target.key.value, e.target.value.value);
	}

	handleEncryptAll(e){
		this.props.encryptAll(this.props.colId);
	}

	NewKeyValueForm(){
		return(
			<form onSubmit={this.handleNewKeyValue}>
				<table><tbody><tr>
					<td><div>Key:<input type="text" name="key"/></div></td>
					<td><div>Value:<input type="text" name="value"/></div></td>
					<td><input type="submit" value="Add KV Pair"/></td>
				</tr></tbody></table>
			</form>
		);
	}

	EncryptAllButton(){
		return(
			<button onClick={this.handleEncryptAll}>Encrypt All</button>
		);
	}

	render(){

		if(!this.props.keyValuesAndIds){
			return(<div>Select a collection.</div>);
		}
		return(
			<table><tbody>
			<tr><td><button onClick={this.handleEncryptAll}>Encrypt All</button></td></tr>
			{
				this.props.keyValuesAndIds.map((singleKVInfo) => { return (
					<tr><td>{this.KeyValueRow(singleKVInfo.id, singleKVInfo.key, singleKVInfo.value)}</td></tr>
				)})
			}
			<tr><td><div>{this.NewKeyValueForm()}</div></td></tr>
			</tbody></table>
		);
	}
}

class CollectionViewer extends React.Component {

	constructor(props){
		super(props);
		this.state = {
			collectionIdsAndNames: props.collectionIdsAndNames,  // Holds colloquial name and collection id
			selectedCollectionId: props.selectedCollectionId
		};
		this.handleNewCollection = this.handleNewCollection.bind(this);
	}

	handleNewCollection(e){
		e.preventDefault();
		this.props.newCollection(e.target.name.value);
	}

	NewCollectionComponent(){
		return(
			<form onSubmit={this.handleNewCollection}>
				<table><tbody><tr>
					<td><input type="text" name="name"/></td>
					<td><input type="submit" value="Add Collection"/></td>
				</tr></tbody></table>
			</form>
		);
	}

	CollectionRow(collectionId, collectionName){
		return(
			<table><tbody><tr>
				<td><div onClick={()=>this.props.collectionClicked(collectionId)}>{collectionName}</div></td>
				<td><button onClick={()=>this.props.updateCollection(collectionId)}>Update</button></td>
				<td><button onClick={()=>this.props.deleteColection(collectionId)}>Delete</button></td>
			</tr></tbody></table>
		);
	}

	render(){

		var collectionIdsAndNames = this.props.collectionIdsAndNames;
		if(!collectionIdsAndNames){
			return(<div>Loading collections.</div>);
		}
		return(
			<table><tbody>
			{
				collectionIdsAndNames.map((info) => { return( 
					<tr><td>{this.CollectionRow(info.id, info.name)}</td></tr>
				)})
			}
			<tr><td><div>{this.NewCollectionComponent()}</div></td></tr>
			</tbody></table>
		);
	}

}



class SampleDataViewer extends React.Component {
	constructor(props){
		super(props);
		this.state = {
			sampleDataArray: props.sampleDataArray
		};
	}

	PolyRow(poly){
		return(
			<tr>
			{
				poly.map((coef) => { return(
					<td>{coef}</td>
				)})
			}
			</tr>
		);
	}

	render(){
		if(this.props.sampleDataArray == null || this.props.sampleDataArray.constructor !== Array){
			return(<div>Select an encrypted key or value</div>);
		}
		return(
			<table><tbody>
			{
				this.props.sampleDataArray.map((poly) =>{ return(
					this.PolyRow(poly)
				)})
			}
			</tbody></table>
		);
	}

}

class App extends React.Component {

	constructor(props){
		super(props);

		this.getCollectionsAndUpdate 	= this.getCollectionsAndUpdate.bind(this);
		this.getKeyValuesAndUpdate 		= this.getKeyValuesAndUpdate.bind(this);
		this.updateCollection 			= this.updateCollection.bind(this);
		this.deleteColection 			= this.deleteColection.bind(this);
		this.newCollection 				= this.newCollection.bind(this);
		this.collectionClicked 			= this.collectionClicked.bind(this);
		this.updateKV 					= this.updateKV.bind(this);
		this.deleteKV 					= this.deleteKV.bind(this);
		this.newKeyValue 				= this.newKeyValue.bind(this);
		this.getEncryptedIdsAndUpdate	= this.getEncryptedIdsAndUpdate.bind(this);
		this.encryptAll 				= this.encryptAll.bind(this);
		this.selectKeyBit 				= this.selectKeyBit.bind(this);
		this.selectValue 				= this.selectValue.bind(this);

		this.state = {
			keyValuesAndIds: null,
			collectionIdsAndNames: null,  // Holds colloquial name and collection id
			selectedCollectionId: null,
			selectedKVInfo: null,
			encryptedIds: null,
			sampleDataArray: null,
		};

		// this.getCollectionsAndUpdate = this.getCollectionsAndUpdate.bind(this);
		// this.getKeyValuesAndUpdate = this.getKeyValuesAndUpdate.bind()

		this.getCollectionsAndUpdate();
	}





	getCollectionsAndUpdate(){
		var getCollectionsUrl = baseUrl+'/collections/'+userId+'/getAll/';
		var getCollectionsPromise = httpRequest(getCollectionsUrl);
		getCollectionsPromise.then((collectionData) => {
			this.setState({collectionIdsAndNames: JSON.parse(collectionData)});
		}).catch(function(err){
			console.log('getAll collections err');
			console.log(err);
		});
	}

	getKeyValuesAndUpdate(colId){
		var getKVUrl = baseUrl+'/collection_plaintext/'+userId+'/'+colId+'/getAll/';
		var getKVPromise = httpRequest(getKVUrl);
		getKVPromise.then((kvData) => {
			this.setState({keyValuesAndIds: JSON.parse(kvData)});
		}).catch(function(err){
			console.log('getAll kvs err');
			console.log(err);
		});
	}





	updateCollection(colId, colName){
		var updateCollectionUrl = baseUrl+'/collections/'+userId+'/update/'+colId+'/'+colName+'/';
		var updateCollectionPromise = httpRequest(updateCollectionUrl);
		updateCollectionPromise.then((updatedCollectionId) => {
			this.getCollectionsAndUpdate();
		}).catch(function(err){
			console.log('update collections err');
			console.log(err);
		});
	}

	deleteColection(colId){
		var deleteCollectionUrl = baseUrl+'/collections/'+userId+'/delete/'+colId+'/';
		var deleteCollectionPromise = httpRequest(deleteCollectionUrl);
		deleteCollectionPromise.then((trueVal) => {
			this.getCollectionsAndUpdate();
		}).catch((err)=> {
			console.log('delete collections err');
			console.log(err);
		});
	}

	newCollection(collectionName){
		console.log("put new");
		var newCollectionUrl = baseUrl+'/collections/'+userId+'/add/'+collectionName+'/';
		var newCollectionPromise = httpRequest(newCollectionUrl);
		newCollectionPromise.then((newId) => {
			this.getCollectionsAndUpdate();
		}).catch((err)=> {
			console.log('new collections err');
			console.log(err);
		});
	}

	collectionClicked(colId){
		this.setState({selectedCollectionId: colId});
		this.getKeyValuesAndUpdate(colId);
		this.getEncryptedIdsAndUpdate(colId);
	}

	updateKV(colId, kvId, key, value){

	}

	deleteKV(colId, kvId){
		var deleteKVUrl = baseUrl+'/collection_plaintext/'+userId+'/'+colId+'/delete/'+kvId+'/';
		var deleteKVPromise = httpRequest(deleteKVUrl);
		deleteKVPromise.then((trueVal) => {
			this.getKeyValuesAndUpdate(colId);
		}).catch((err)=> {
			console.log('delete kv err');
			console.log(err);
		});
	}

	newKeyValue(colId, key, value){
		var newKVUrl = baseUrl+'/collection_plaintext/'+userId+'/'+colId+'/add/'+key+'/'+value+'/';
		var newKVPromise = httpRequest(newKVUrl);
		newKVPromise.then((newKVId) => {
			this.getKeyValuesAndUpdate(colId);
		}).catch((err)=> {
			console.log('new kv err');
			console.log(err);
		});
	}

	getEncryptedIdsAndUpdate(colId){
		var getAllEncryptedIdsUrl 	= baseUrl+'/ciphertext/'+userId+'/'+colId+'/getEncryptedIds/';
		var getEncryptedIdsPromise 	= httpRequest(getAllEncryptedIdsUrl);
		getEncryptedIdsPromise.then((retJson) => {
			this.setState({encryptedIds: JSON.parse(retJson)});
		}).catch((err)=> {
			console.log("get ids err");
			console.log(err);
		});
	}

	encryptAll(colId){
		var encryptAllUrl 		= baseUrl+'/encrypt_collection/'+userId+'/'+colId+'/encrypt_all/';
		var newEncryptPromise 	= httpRequest(encryptAllUrl);
		newEncryptPromise.then((isTrue) => {
			console.log("finished encrypting");
			this.getEncryptedIdsAndUpdate(colId);
		}).catch((err)=> {
			console.log("enc all err");
			console.log(err);
		});
	}


	selectKeyBit(colId, kvId, bitId){
		var keyBitSampleUrl = baseUrl+'/ciphertext/'+userId+'/'+colId+'/getCiphertextKeyBitSample/'+kvId+'/'+bitId+'/';
		var keyBitSamplePromise = httpRequest(keyBitSampleUrl);
		keyBitSamplePromise.then((retJson) => {
			this.setState({sampleDataArray: JSON.parse(retJson)});
		}).catch((err)=> {
			console.log("selectKeyBit err");
			console.log(err);
		});
	}

	selectValue(colId, kvId){
		var valueSampleUrl = baseUrl+'/ciphertext/'+userId+'/'+colId+'/getCiphertextValueSample/'+kvId+'/';
		var valueSamplePromise = httpRequest(valueSampleUrl);
		valueSamplePromise.then((retJson) => {
			this.setState({sampleDataArray: JSON.parse(retJson)});
		}).catch((err)=> {
			console.log("selectValue err");
			console.log(err);
		});
	}

	render(){
		return (
			<table><tbody><tr>
				<td>
					<CollectionViewer 
						collectionIdsAndNames	={this.state.collectionIdsAndNames}
						selectedCollectionId	={this.state.selectedCollectionId} 
						newCollection 			={this.newCollection}
						collectionClicked 		={this.collectionClicked}
						deleteColection 		={this.deleteColection}
						updateCollection		={this.updateCollection}/>
				</td>
				<td>
					<table><tbody>
						<tr><td>
							<KeyValueViewer
								colId 			={this.state.selectedCollectionId}
								keyValuesAndIds ={this.state.keyValuesAndIds}
								selectedKVInfo 	={this.state.selectedKVInfo}
								encryptedIds 	={this.state.encryptedIds}
								updateKV 		={this.updateKV}
								deleteKV 		={this.deleteKV}
								newKeyValue 	={this.newKeyValue}
								encryptAll 		={this.encryptAll}
								selectKeyBit 	={this.selectKeyBit}
								selectValue 	={this.selectValue}/>
						</td></tr>
						<tr><td>
							<QueryBox
								colId ={this.state.selectedCollectionId}/>
						</td></tr>
						<tr><td>
							<SampleDataViewer
								sampleDataArray ={this.state.sampleDataArray}/>
						</td></tr>
					</tbody></table>
				</td>
			</tr></tbody></table>
		);
	}
}



ReactDOM.render(
  <App/>,
  document.getElementById('root')
);

		</script>
	</body>
</html>